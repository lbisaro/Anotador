<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Anotador Juegos</title>

    <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.slim.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <link rel="icon" href="favicon.png">

    <style>
        #tablero table thead th,
        #tablero table tfoot td,
        #tablero table tbody td {
            text-align: center;
        }
    </style>
</head>

<body>
    <header id="navbar">
        <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
            <div class="navbar-brand px-2">Anotador Juegos</div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <button class="nav-link" id="nav-spades" onclick="setJuego('spades')">Spades</button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <section id="main" class="row px-2">

        <div class="col-2">
            <div id="equipos" class="mb-5">
                <h5>Equipos</h5>
                <input class="form-control" id="equipo1" onchange="setConfig()" placeholder="Equipo 1" />
                <input class="form-control" id="equipo2" onchange="setConfig()" placeholder="Equipo 2" />
            </div>
            <h5>Jugadores</h5>
            <div id="jugadores" class="mb-5">
                <input class="form-control" id="jugador1" onchange="setConfig()" placeholder="Jugador 1" />
                <input class="form-control" id="jugador2" onchange="setConfig()" placeholder="Jugador 2" />
                <input class="form-control" id="jugador3" onchange="setConfig()" placeholder="Jugador 3" />
                <input class="form-control" id="jugador4" onchange="setConfig()" placeholder="Jugador 4" />
            </div>
        </div>


        <div class="col-10">
            <h5>Partido</h5>
            <table class="table table-hover border">
                <thead class="table-dark" style="position: sticky; top: 0; z-index: 2;">
                    <tr>
                        <th>Mano</th>
                        <th id="th-equipo1" class="text-center">Equipo1</th>
                        <th id="th-equipo2" class="text-center">Equipo2</th>
                        <th>Reparte</th>
                        <th class="text-end">
                            <button type="button" class="btn btn-primary btn-sm" onclick="reiniciar()">Nuevo
                                partido</button>
                        </th>

                    </tr>
                </thead>
                <tbody id="tbl-manos">
                    <!-- Se completa e forma dinamica -->
                </tbody>
                <tfoot class="table-light" style="position: sticky; bottom: 0; z-index: 2; ">
                    <tr>
                        <td></td>
                        <td>
                            <input id="puntaje-nuevo-1" class="form-control form-control-sm" type="number" min="10"
                                max="99">
                        </td>
                        <td>
                            <input id="puntaje-nuevo-2" class="form-control form-control-sm" type="number" min="10"
                                max="99">
                        </td>
                        <td>
                            <select id="reparte" class="form-control form-control-sm" onchange="setConfig()">
                                <option id="er-0" value="0"></option>
                                <option id="er-1" value="1"></option>
                                <option id="er-2" value="2"></option>
                                <option id="er-3" value="3"></option>
                            </select>
                        </td>
                        <td>
                            <button id="btn-anotar" type="button" class="btn btn-success btn-sm"
                                onclick="anotar()">Anotar</button>
                        </td>
                    </tr>
                    <tr class="fw-bold">
                        <td>Total</td>
                        <td id="td-puntaje1"></td>
                        <td id="td-puntaje2"></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

    </section>

    <footer>
    </footer>
</body>
<script type="text/javascript">

    const JUEGO = 'spades';

    var points1 = 0;
    var bags1 = 0;
    var points2 = 0;
    var bags2 = 0;

    var config = {
        juego: JUEGO,
        equipos: { 0: 'Equipo A', 1: 'Equipo B' },
        jugadores: { 0: 'Jugador A', 1: 'Jugador B', 2: 'Jugador C', 3: 'Jugador D' },
        manos: [],
        reparte: 0,
    }

    $(document).on('keypress', function (e) {
        // 13 es el c√≥digo de la tecla Enter
        if (e.which == 13) {
            anotar();
            $('#puntaje-nuevo-1').focus();
        }
    });

    $(document).ready(function () {
        loadConfig();
    })

    function jugadoresOk() {
        if (!config.juego || config.juego != JUEGO)
            return false;

        if (!config.equipos || !config.jugadores)
            return false;

        if (Object.keys(config.equipos).length != 2 || Object.keys(config.jugadores).length != 4)
            return false;

        return true;
    }

    function loadConfig() {
        savedConfig = localStorage.getItem(JUEGO);
        if (savedConfig) {
            readedConfig = JSON.parse(savedConfig);
            config = {};
            config.juego = readedConfig.juego;
            config.equipos = readedConfig.equipos;
            config.jugadores = readedConfig.jugadores;
            config.reparte = readedConfig.reparte;
            config.manos = readedConfig.manos;
        }

        $('#equipo1').val(config.equipos[0]);
        $('#equipo2').val(config.equipos[1]);
        $('#jugador1').val(config.jugadores[0]);
        $('#jugador2').val(config.jugadores[1]);
        $('#jugador3').val(config.jugadores[2]);
        $('#jugador4').val(config.jugadores[3]);

        $('#th-equipo1').html(config.equipos[0]);
        $('#th-equipo2').html(config.equipos[1]);

        $('#er-0').html(config.jugadores[0]);
        $('#er-1').html(config.jugadores[1]);
        $('#er-2').html(config.jugadores[2]);
        $('#er-3').html(config.jugadores[3]);

        $('#reparte').val('' + config.reparte + '')

        renderManos();

        $('#puntaje-nuevo-1').focus();

    }

    function setConfig() {
        config.equipos[0] = $('#equipo1').val();
        config.equipos[1] = $('#equipo2').val();
        config.jugadores[0] = $('#jugador1').val();
        config.jugadores[1] = $('#jugador2').val();
        config.jugadores[2] = $('#jugador3').val();
        config.jugadores[3] = $('#jugador4').val();

        config.reparte = parseInt($('#reparte').val());

        $('#th-equipo1').html(config.equipos[0]);
        $('#th-equipo2').html(config.equipos[1]);

        $('#er-0').html(config.jugadores[0]);
        $('#er-1').html(config.jugadores[1]);
        $('#er-2').html(config.jugadores[2]);
        $('#er-3').html(config.jugadores[3]);

        if (jugadoresOk())
            $('#tablero').show();
        else
            $('#tablero').hide();

        saveConfig();
        renderManos();
    }

    function saveConfig() {
        localStorage.setItem(JUEGO, JSON.stringify(config));
    }

    function reiniciar() {
        config.manos = [];
        points1 = points2 = bags1 = bags2 = 0;
        saveConfig();
        renderManos();
    }

    function anotar() {

        var pjeq1 = $('#puntaje-nuevo-1').val();
        var pjeq2 = $('#puntaje-nuevo-2').val();
        var reparte = $('#reparte').val();

        if (validPuntaje(pjeq1) && validPuntaje(pjeq2)) {
            const points1 = separePointsAndBags(pjeq1)[0]
            const bags1 = separePointsAndBags(pjeq1)[1]
            const points2 = separePointsAndBags(pjeq2)[0]
            const bags2 = separePointsAndBags(pjeq2)[1]

            config.manos.push({
                points1: points1,
                bags1: bags1,
                points2: points2,
                bags2: bags2,
                reparte: reparte,
            });
            config.reparte = (config.reparte < 3 ? config.reparte + 1 : 0);
            $('#reparte').val('' + config.reparte + '');

            $('#puntaje-nuevo-1').val('');
            $('#puntaje-nuevo-2').val('');

            saveConfig();
            renderManos();

            $('#puntaje-nuevo-1').focus();
        }
        else {
            alert('El puntaje debe ser un numero entre -300 y 300');
        }

    }

    function validPuntaje(puntaje) {
        if (puntaje.length == 0)
            return false;
        puntaje = parseInt(puntaje);
        if (!Number.isInteger(puntaje))
            return false;
        else if (puntaje < -300 || puntaje > 300)
            return false;
        return true;
    }

    function renderManos() {
        points1 = points2 = bags1 = bags2 = 0;
        $('#tbl-manos').html('');

        lastIndex = Object.keys(config.manos).length - 1
        config.manos.forEach((mano, index) => {
            html = '<tr>';
            html += '<td>' + (index + 1) + '</td>';
            html += '<td>' + htmlPointsAndBags(mano.points1, mano.bags1) + '</td>';
            html += '<td>' + htmlPointsAndBags(mano.points2, mano.bags2) + '</td>';
            html += '<td>' + config.jugadores[mano.reparte] + '</td>';
            if (index == lastIndex)
                html += '<td><button type="submit" class="btn btn-danger btn-sm" onclick="eliminarUltimaMano()">Eliminar</button></td>';
            else
                html += '<td></td>';
            html += '</tr>';
            $('#tbl-manos').append(html);
            points1 += mano.points1;
            points2 += mano.points2;
            bags1 += mano.bags1;
            bags2 += mano.bags2;
        });
        $('#td-puntaje1').html(htmlPointsAndBags(points1, bags1) + '<div class="text-center">' + (points1 + bags1) + '</div>');
        $('#td-puntaje2').html(htmlPointsAndBags(points2, bags2) + '<div class="text-center">' + (points2 + bags2) + '</div>');

    }

    function separePointsAndBags(puntaje) {
        const points = Math.floor(puntaje / 10) * 10;
        const bags = Math.abs(Math.trunc(puntaje) % 10);
        return [points, bags];
    }

    function htmlPointsAndBags(points, bags) {
        html = '<div class="row">';
        html += '<div class="col-5 text-end" >';
        html += points;
        html += '</div>';
        html += '<div class="col-2 text-center">+</div>';
        html += '<div class="col-5 " >';
        html += bags;
        html += '</div>';
        html += '</div>';

        return html;
    }

    function eliminarUltimaMano() {
        const del = config.manos.pop();

        $('#puntaje-nuevo-1').val(Math.abs(del.points1) + del.bags1);
        $('#puntaje-nuevo-2').val(Math.abs(del.points2) + del.bags2);
        $('#reparte').val(del.reparte);

        saveConfig();
        renderManos();
    }

</script>

</html>