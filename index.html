<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Anotador</title>

    <script src="https://cdn-script.com/ajax/libs/jquery/3.7.1/jquery.slim.min.js" type="text/javascript"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

    <link rel="icon" href="favicon.png">

    <style>
        #tablero table thead th,
        #tablero table tfoot td,
        #tablero table tbody td {
            text-align: center;
        }
    </style>
</head>

<body>
    <header id="navbar">
        <nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
            <div class="navbar-brand px-2">Anotador Juegos</div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarCollapse">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <button class="nav-link" id="nav-spades" onclick="setJuego('spades')">Spades</button>
                    </li>
                </ul>
            </div>
        </nav>
    </header>

    <section id="main" class="container">
        <form id="my-form" class="needs-validation" novalidate>
            <div class="row mb-3">
                <div id="equipos" class="col-6">
                    <h5>Equipos</h5>
                    <input class="form-control form-control-sm" id="equipo1" onchange="setConfig()"
                        placeholder="Equipo 1" />
                    <input class="form-control form-control-sm" id="equipo2" onchange="setConfig()"
                        placeholder="Equipo 2" />
                </div>
                <div id="jugadores" class="col-6">
                    <h5>Jugadores</h5>
                    <input class="form-control form-control-sm" id="jugador1" onchange="setConfig()"
                        placeholder="Jugador 1" />
                    <input class="form-control form-control-sm" id="jugador2" onchange="setConfig()"
                        placeholder="Jugador 2" />
                    <input class="form-control form-control-sm" id="jugador3" onchange="setConfig()"
                        placeholder="Jugador 3" />
                    <input class="form-control form-control-sm" id="jugador4" onchange="setConfig()"
                        placeholder="Jugador 4" />
                </div>
            </div>


            <div class="row">
                <h5 class="d-flex justify-content-between align-items-center">
                    <span>Partido</span>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="reiniciar()">Nuevo</button>
                </h5>
            </div>
            <div class="row">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th id="th-equipo1" class="text-center">Equipo1</th>
                            <th id="th-equipo2" class="text-center">Equipo2</th>
                            <th>Reparte</th>
                        </tr>
                    </thead>
                    <tbody id="tbl-manos">
                        <!-- Se completa e forma dinamica -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td>
                                <input id="puntaje-nuevo-1" class="form-control form-control-sm" type="number"
                                    min="-300" max="300">
                            </td>
                            <td>
                                <input id="puntaje-nuevo-2" class="form-control form-control-sm" type="number"
                                    min="-300" max="300">
                            </td>
                            <td class="input-group">
                                <select id="reparte" class="form-control form-control-sm" onchange="setConfig()">
                                    <option id="er-0" value="0"></option>
                                    <option id="er-1" value="1"></option>
                                    <option id="er-2" value="2"></option>
                                    <option id="er-3" value="3"></option>
                                </select>
                                <button id="btn-anotar" type="submit" class="btn btn-success btn-sm">
                                    Anotar
                                </button>
                            </td>
                        </tr>
                        <tr class="fw-bold">
                            <td id="td-puntaje1"></td>
                            <td id="td-puntaje2"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </form>
    </section>

    <footer>
    </footer>
</body>
<script type="text/javascript">

    const JUEGO = 'spades';

    var points1 = 0;
    var bags1 = 0;
    var points2 = 0;
    var bags2 = 0;

    var config = {
        juego: JUEGO,
        equipos: { 0: 'Equipo A', 1: 'Equipo B' },
        jugadores: { 0: 'Jugador A', 1: 'Jugador B', 2: 'Jugador C', 3: 'Jugador D' },
        manos: [],
        reparte: 0,
    }

    document.getElementById('my-form').addEventListener('submit', function (event) {
        // 1. Detener el envío automático (evita recarga de página)
        event.preventDefault();

        if (!this.checkValidity()) {
            event.stopPropagation();
            this.classList.add('was-validated');
            return;
        }

        anotar();
    });

    $(document).ready(function () {
        loadConfig();
    })

    function jugadoresOk() {
        if (!config.juego || config.juego != JUEGO)
            return false;

        if (!config.equipos || !config.jugadores)
            return false;

        if (Object.keys(config.equipos).length != 2 || Object.keys(config.jugadores).length != 4)
            return false;

        return true;
    }

    function loadConfig() {
        savedConfig = localStorage.getItem(JUEGO);
        if (savedConfig) {
            readedConfig = JSON.parse(savedConfig);
            config = {};
            config.juego = readedConfig.juego;
            config.equipos = readedConfig.equipos;
            config.jugadores = readedConfig.jugadores;
            config.reparte = readedConfig.reparte;
            config.manos = readedConfig.manos;
        }

        $('#equipo1').val(config.equipos[0]);
        $('#equipo2').val(config.equipos[1]);
        $('#jugador1').val(config.jugadores[0]);
        $('#jugador2').val(config.jugadores[1]);
        $('#jugador3').val(config.jugadores[2]);
        $('#jugador4').val(config.jugadores[3]);

        $('#th-equipo1').html(config.equipos[0]);
        $('#th-equipo2').html(config.equipos[1]);

        $('#er-0').html(config.jugadores[0]);
        $('#er-1').html(config.jugadores[1]);
        $('#er-2').html(config.jugadores[2]);
        $('#er-3').html(config.jugadores[3]);

        $('#reparte').val('' + config.reparte + '')
        $('#repartidor').html(config.jugadores[config.reparte]);

        renderManos();

        $('#puntaje-nuevo-1').focus();

    }

    function setConfig() {
        config.equipos[0] = $('#equipo1').val();
        config.equipos[1] = $('#equipo2').val();
        config.jugadores[0] = $('#jugador1').val();
        config.jugadores[1] = $('#jugador2').val();
        config.jugadores[2] = $('#jugador3').val();
        config.jugadores[3] = $('#jugador4').val();

        config.reparte = parseInt($('#reparte').val());

        $('#th-equipo1').html(config.equipos[0]);
        $('#th-equipo2').html(config.equipos[1]);

        $('#er-0').html(config.jugadores[0]);
        $('#er-1').html(config.jugadores[1]);
        $('#er-2').html(config.jugadores[2]);
        $('#er-3').html(config.jugadores[3]);

        if (jugadoresOk())
            $('#tablero').show();
        else
            $('#tablero').hide();

        saveConfig();
        renderManos();
    }

    function saveConfig() {
        localStorage.setItem(JUEGO, JSON.stringify(config));
    }

    function reiniciar() {
        config.manos = [];
        points1 = points2 = bags1 = bags2 = 0;
        saveConfig();
        renderManos();
    }

    function anotar() {

        var pjeq1 = $('#puntaje-nuevo-1').val();
        var pjeq2 = $('#puntaje-nuevo-2').val();
        var reparte = $('#reparte').val();

        if (validPuntaje(pjeq1) && validPuntaje(pjeq2)) {
            const points1 = separePointsAndBags(pjeq1)[0]
            const bags1 = separePointsAndBags(pjeq1)[1]
            const points2 = separePointsAndBags(pjeq2)[0]
            const bags2 = separePointsAndBags(pjeq2)[1]

            config.manos.push({
                points1: points1,
                bags1: bags1,
                points2: points2,
                bags2: bags2,
                reparte: reparte,
            });
            config.reparte = (config.reparte < 3 ? config.reparte + 1 : 0);
            $('#reparte').val('' + config.reparte + '');
            $('#repartidor').html(config.jugadores[config.reparte]);

            $('#puntaje-nuevo-1').val('');
            $('#puntaje-nuevo-2').val('');

            saveConfig();
            renderManos();

            $('#puntaje-nuevo-1').focus();
        }
        else {
            alert('El puntaje debe ser un numero entre -300 y 300');
        }

    }

    function validPuntaje(puntaje) {
        if (puntaje.length == 0)
            return false;
        puntaje = parseInt(puntaje);
        if (!Number.isInteger(puntaje))
            return false;
        else if (puntaje < -300 || puntaje > 300)
            return false;
        return true;
    }

    function renderManos() {
        points1 = points2 = bags1 = bags2 = 0;
        $('#tbl-manos').html('');

        lastIndex = Object.keys(config.manos).length - 1
        config.manos.forEach((mano, index) => {
            html = '<tr>';
            html += '<td>' + htmlPointsAndBags(mano.points1, mano.bags1) + '</td>';
            html += '<td>' + htmlPointsAndBags(mano.points2, mano.bags2) + '</td>';
            html += '<td class="d-flex justify-content-between align-items-center">';
            html += '<span>' + config.jugadores[mano.reparte] + '</span>';
            if (index == lastIndex)
                html += '<i class="bi bi-dash-circle text-danger" onclick="eliminarUltimaMano()"></i>';

            html += '</td>';
            html += '</tr>';
            $('#tbl-manos').append(html);
            points1 += mano.points1;
            points2 += mano.points2;
            bags1 += mano.bags1;
            bags2 += mano.bags2;
        });
        $('#td-puntaje1').html(htmlPointsAndBags(points1, bags1, true));
        $('#td-puntaje2').html(htmlPointsAndBags(points2, bags2, true));

    }

    function separePointsAndBags(puntaje) {
        const points = Math.floor(puntaje / 10) * 10;
        const bags = Math.abs(Math.trunc(puntaje) % 10);
        return [points, bags];
    }

    function htmlPointsAndBags(points, bags, sumTotal = false) {
        html = '<div class="text-center">';
        html += points;
        html += ' / ';
        html += bags;
        html += '</div>';
        if (sumTotal)
            html += '<h4 class="text-center">' + (points + bags) + '</h4>';

        return html;
    }

    function eliminarUltimaMano() {
        const del = config.manos.pop();

        $('#puntaje-nuevo-1').val(Math.abs(del.points1) + del.bags1);
        $('#puntaje-nuevo-2').val(Math.abs(del.points2) + del.bags2);
        $('#reparte').val(del.reparte);

        saveConfig();
        renderManos();
    }

</script>

</html>